<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.clish.course.mapper.UserClassMapper">

	<!-- 예약 정보 등록 INSERT -->
	<insert id="insertReservation">
		INSERT
		INTO RESERVATION 
		VALUES (
			#{reservationIdx}
			, #{userIdx}
			, #{reservationMembers}
			, #{reservationClassDate}
			, now()
			, #{classIdx}
			, 1
		)
	</insert>
	
	<!-- 총 예약 인원 확인 SELECT -->
	<select id="selectCountReservationMembers" resultType="int">
		SELECT 
			IFNULL(SUM(reservation_members), 0)
		FROM 
			RESERVATION
		WHERE 
			class_idx = #{classIdx};
	</select>
	
	<!-- 유저idx SELCT -->
	<select id="selectUser" resultType="com.itwillbs.clish.user.dto.UserDTO">
		SELECT
			user_idx
		FROM
			USER
		WHERE
			user_id = #{userId}
	</select>
	
	<!-- 클래스 정보 조회 SELECT -->
	<select id="selectClass" resultType="com.itwillbs.clish.course.dto.ClassDTO">
		SELECT *
		FROM 
			CLASS
		WHERE 
			class_type = #{classType}
			<!-- 카테고리별 정렬 검색조건 -->
			<if test="categoryIdx != null">
			AND
			category_idx LIKE CONCAT('%', #{categoryIdx}, '%')
			</if>
	</select>
	
	<!-- 클래스상세페이지 리뷰 카운트 SELECT -->
	<select id="selectCountClassReview" resultType="int"> 
		SELECT count(*)
		FROM REVIEW
		WHERE class_idx = #{classIdx}
	</select>
	
	<!-- 클래스상세페이지 리뷰 불러오기 -->
	<resultMap type="com.itwillbs.clish.myPage.dto.ReviewDTO" id="ReviewDTOListWithfileDTOListResultMap">
		<id property="reviewIdx" column="review_idx" />
		<result property="reservationIdx" column="reservation_idx" />
		<result property="userIdx" column="user_idx" />
		<result property="classIdx" column="class_idx" />
		<result property="reviewTitle" column="review_title" />
		<result property="reviewDetail" column="review_detail" />
		<result property="reviewScore" column="review_score" />
		<result property="reviewCreatedAt" column="review_created_at" />
		<result property="reviewModifiedAt" column="review_modified_at" />
		<result property="reviewReportedCount" column="review_reported_count" />
		<result property="classTitle" column="class_title" />
		<result property="categoryIdx" column="category_idx" />
		<result property="classType" column="class_type" />
		<result property="reservationClassDate" column="reservation_class_date" />
		<result property="userId" column="user_id" />
		<result property="userName" column="user_name" />
		
		<collection property="fileList" ofType="com.itwillbs.clish.common.file.FileDTO"
		column="review_idx" select="selectFilesByReviewIdx"/>
	</resultMap>
	
	<select id="selectAllClassReview" resultMap="ReviewDTOListWithfileDTOListResultMap">
		SELECT rev.*,
				c.class_title,
				c.category_idx,
				c.class_type,
				r.reservation_class_date,
				u.user_id,
				u.user_name
				
		FROM REVIEW rev
		LEFT JOIN CLASS c
			ON rev.class_idx = c.class_idx
		LEFT JOIN RESERVATION r
			ON rev.reservation_idx = r.reservation_idx
		LEFT JOIN USER u
			ON rev.user_idx = u.user_idx
		WHERE rev.class_idx = #{classIdx}
		LIMIT
			#{startRow}
			, #{listLimit}
	</select>
	
	<!-- 리뷰idx로 첨부 파일 조회 SELECT -->
	<select id="selectFilesByReviewIdx" parameterType="String" resultType="com.itwillbs.clish.common.file.FileDTO">
		SELECT *
		FROM FILE
		WHERE idx = #{reviewIdx}
	</select>
	

</mapper>























